--- origsrc/gperftools-gperftools-2.17.2/Makefile.am	2025-08-16 02:35:13.000000000 +0900
+++ src/gperftools-gperftools-2.17.2/Makefile.am	2025-11-26 16:02:03.892241900 +0900
@@ -259,7 +259,7 @@ libtcmalloc_minimal_la_SOURCES = $(TCMAL
 libtcmalloc_minimal_la_CXXFLAGS = -DNO_TCMALLOC_SAMPLES \
                                   -DNDEBUG $(AM_CXXFLAGS)
 # -version-info gets passed to libtool
-libtcmalloc_minimal_la_LDFLAGS = -version-info @TCMALLOC_SO_VERSION@ $(AM_LDFLAGS)
+libtcmalloc_minimal_la_LDFLAGS = -no-undefined -version-info @TCMALLOC_SO_VERSION@ $(AM_LDFLAGS)
 libtcmalloc_minimal_la_LIBADD = libcommon.la
 
 ### ------- unit tests for various internal modules of tcmalloc
@@ -596,7 +596,7 @@ lib_LTLIBRARIES += libtcmalloc.la
 libtcmalloc_la_SOURCES = $(TCMALLOC_CC) $(FULL_MALLOC_SRC)
 libtcmalloc_la_CXXFLAGS = -DNDEBUG $(AM_CXXFLAGS) \
                           $(EMERGENCY_MALLOC_DEFINE)
-libtcmalloc_la_LDFLAGS = -version-info @TCMALLOC_SO_VERSION@ $(AM_LDFLAGS)
+libtcmalloc_la_LDFLAGS = -no-undefined -version-info @TCMALLOC_SO_VERSION@ $(AM_LDFLAGS)
 libtcmalloc_la_LIBADD = libstacktrace.la liblow_level_alloc.la libcommon.la
 
 ### Unittests
@@ -757,7 +757,7 @@ libprofiler_la_SOURCES = src/profiler.cc
 libprofiler_la_LIBADD = libstacktrace.la libcommon.la
 # We have to include ProfileData for profiledata_unittest
 CPU_PROFILER_SYMBOLS = '(ProfilerStart|ProfilerStartWithOptions|ProfilerStop|ProfilerFlush|ProfilerEnable|ProfilerDisable|ProfilingIsEnabledForAllThreads|ProfilerRegisterThread|ProfilerGetCurrentState|ProfilerState|ProfileData|ProfileHandler|ProfilerGetStackTrace)'
-libprofiler_la_LDFLAGS = -export-symbols-regex $(CPU_PROFILER_SYMBOLS) \
+libprofiler_la_LDFLAGS = -no-undefined -export-symbols-regex $(CPU_PROFILER_SYMBOLS) \
                          -version-info @PROFILER_SO_VERSION@
 
 ### Unittests
@@ -826,7 +826,7 @@ libtcmalloc_and_profiler_la_SOURCES = $(
 libtcmalloc_and_profiler_la_CXXFLAGS = $(libtcmalloc_la_CXXFLAGS) $(libprofiler_la_CXXFLAGS)
 # Since this library is meant to be used as a .a, I don't worry as much
 # about .so versioning.  I just give the libtcmalloc version number.
-libtcmalloc_and_profiler_la_LDFLAGS = -version-info @TCMALLOC_AND_PROFILER_SO_VERSION@ \
+libtcmalloc_and_profiler_la_LDFLAGS = -no-undefined -version-info @TCMALLOC_AND_PROFILER_SO_VERSION@ \
                                       $(AM_LDFLAGS)
 libtcmalloc_and_profiler_la_LIBADD = $(libtcmalloc_la_LIBADD)
 
--- origsrc/gperftools-gperftools-2.17.2/src/base/basictypes.h	2025-08-16 02:35:13.000000000 +0900
+++ src/gperftools-gperftools-2.17.2/src/base/basictypes.h	2025-11-26 16:10:20.632212500 +0900
@@ -128,7 +128,7 @@ inline void bit_store(Dest *dest, const
   memcpy(dest, source, sizeof(Dest));
 }
 
-#ifdef HAVE___ATTRIBUTE__
+#if defined(HAVE___ATTRIBUTE__) && defined(__ELF__)
 # define ATTRIBUTE_WEAK      __attribute__((weak))
 # define ATTRIBUTE_NOINLINE  __attribute__((noinline))
 #else
--- origsrc/gperftools-gperftools-2.17.2/src/base/sysinfo.cc	2025-08-16 02:35:13.000000000 +0900
+++ src/gperftools-gperftools-2.17.2/src/base/sysinfo.cc	2025-11-26 16:38:07.562738900 +0900
@@ -425,8 +425,7 @@ const char* GetProgramInvocationName() {
   static const char* argv0 = readlink_strdup("/proc/self/path/a.out");
   return argv0;
 #elif defined(HAVE_PROGRAM_INVOCATION_NAME)
-  extern char* program_invocation_name;  // gcc provides this
-  return program_invocation_name;
+  return ::program_invocation_name;
 #elif defined(__MACH__)
   // We don't want to allocate memory for this since we may be
   // calculating it when memory is corrupted.
--- origsrc/gperftools-gperftools-2.17.2/src/base/threading.h	2025-08-16 02:35:13.000000000 +0900
+++ src/gperftools-gperftools-2.17.2/src/base/threading.h	2025-11-26 16:19:07.649294300 +0900
@@ -99,7 +99,8 @@ using TlsKey = pthread_key_t;
 // in standard (even without pthread_key_create_once_np), but we
 // have what we have. It's value is (int)(-1). And, indeed, -1 seems
 // like most sensible value.
-constexpr inline TlsKey kInvalidTLSKey = static_cast<TlsKey>(~uintptr_t{0});
+//
+inline TlsKey kInvalidTLSKey = reinterpret_cast<TlsKey>(~uintptr_t{0});
 static_assert(sizeof(pthread_key_t) <= sizeof(uintptr_t));
 
 ATTRIBUTE_VISIBILITY_HIDDEN inline int CreateTlsKey(TlsKey *pkey, void (*destructor)(void*)) {
--- origsrc/gperftools-gperftools-2.17.2/src/tests/generic_writer_test.cc	2025-08-16 02:35:13.000000000 +0900
+++ src/gperftools-gperftools-2.17.2/src/tests/generic_writer_test.cc	2025-11-26 16:46:07.500284500 +0900
@@ -47,7 +47,11 @@ TEST(GenericWriterTest, File) {
   }
 
   {
+#if defined(__CYGWIN__)
+    tcmalloc::RawFDGenericWriter<128> writer(reinterpret_cast<RawFD>(static_cast<intptr_t>(fileno(f))));
+#else
     tcmalloc::RawFDGenericWriter<128> writer(static_cast<RawFD>(fileno(f)));
+#endif
     PrintLargeAmount(&writer);
   }
 
--- origsrc/gperftools-gperftools-2.17.2/src/tests/min_per_thread_cache_size_test.cc	2025-08-16 02:35:13.000000000 +0900
+++ src/gperftools-gperftools-2.17.2/src/tests/min_per_thread_cache_size_test.cc	2025-11-26 17:02:10.615884000 +0900
@@ -34,6 +34,8 @@
 #include <new>
 #include <thread>
 #include <vector>
+#include <condition_variable>
+#include <mutex>
 
 #include <gperftools/malloc_extension.h>
 #include <gperftools/malloc_extension_c.h>
